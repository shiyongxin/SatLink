<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Calculation - SatLink</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .param-detail-item {
            background-color: #f8f9fa;
            border-left: 3px solid #007bff;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .param-detail-item .param-title {
            font-weight: 600;
            color: #007bff;
            margin-bottom: 5px;
            font-size: 0.95em;
        }
        .param-detail-item table {
            margin-bottom: 0;
            font-size: 0.85em;
        }
        .param-detail-item td {
            padding: 2px 8px 2px 0;
            border: none;
        }
        .param-detail-item .label {
            font-weight: 500;
            color: #495057;
        }
        .param-details-panel {
            max-height: 600px;
            overflow-y: auto;
        }
        .empty-state {
            color: #6c757d;
            text-align: center;
            padding: 40px 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">SatLink</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/dashboard">Dashboard</a>
                <a class="nav-link" href="/calculate">Calculate</a>
                <a class="nav-link" href="/calculations">Calculations</a>
                <a class="nav-link" href="/manage">Manage</a>
                <a class="nav-link" href="/public">Public</a>
                <a class="nav-link" href="/profile">Profile</a>
                <a class="nav-link" href="/logout">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <h1>Link Calculation</h1>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Input Parameters</h5>
                    </div>
                    <div class="card-body">
                        <form id="calculationForm">
                            <!-- Satellite -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <label for="satellite" class="form-label">Satellite</label>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addNewSatellite()">+ Add New</button>
                                </div>
                                <select class="form-select" id="satellite" name="satellite_id" required>
                                    <option value="">Select Satellite</option>
                                    {% for sat in satellites %}
                                        <option value="{{ sat.id }}">{{ sat.name }} ({{ sat.sat_long }}°)</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Transponder -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <label for="transponder" class="form-label">Transponder</label>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addNewTransponder()">+ Add New</button>
                                </div>
                                <select class="form-select" id="transponder" name="transponder_id" required>
                                    <option value="">Select Transponder</option>
                                </select>
                            </div>

                            <!-- Carrier -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <label for="carrier" class="form-label">Carrier</label>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addNewCarrier()">+ Add New</button>
                                </div>
                                <select class="form-select" id="carrier" name="carrier_id" required>
                                    <option value="">Select Carrier</option>
                                    {% for car in carriers %}
                                        <option value="{{ car.id }}">{{ car.name }} ({{ car.modcod }})</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Ground Station -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <label for="ground_station" class="form-label">Ground Station</label>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addNewGroundStation()">+ Add New</button>
                                </div>
                                <select class="form-select" id="ground_station" name="ground_station_id" required>
                                    <option value="">Select Ground Station</option>
                                    {% for gs in ground_stations %}
                                        <option value="{{ gs.id }}">{{ gs.name }} ({{ gs.city }}, {{ gs.country }})</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Reception Type -->
                            <div class="mb-3">
                                <label for="reception_type" class="form-label">Reception System Type</label>
                                <select class="form-select" id="reception_type" name="reception_type" required>
                                    <option value="">Select Type</option>
                                    <option value="complex">Complex (Detailed Hardware)</option>
                                    <option value="simple">Simple (G/T Value)</option>
                                </select>
                            </div>

                            <div class="mb-3" id="reception_system" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <label for="reception_id" class="form-label">Reception System</label>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addNewReceptionSystem()">+ Add New</button>
                                </div>
                                <select class="form-select" id="reception_id" name="reception_id" required>
                                    <option value="">Select System</option>
                                </select>
                            </div>

                            <button type="submit" class="btn btn-primary">Calculate</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <!-- Calculation Results -->
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Calculation Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="results" class="text-center">
                            <p class="text-muted">Complete the form to see results</p>
                        </div>
                    </div>
                </div>

                <!-- Parameter Details Panel -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Parameter Details</h5>
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#paramDetailsBody">
                            Hide/Show
                        </button>
                    </div>
                    <div class="collapse show" id="paramDetailsBody">
                        <div class="card-body param-details-panel" id="paramDetails">
                            <div class="empty-state">
                                <p>Select parameters to see details</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Store selected component data
        let selectedComponents = {};
        let currentReceptionType = null;
        let allTransponders = {};

        // Store all component data from server
        {% if satellites %}
        const allSatellites = {
            {% for sat in satellites %}
            {{ sat.id }}: {
                id: {{ sat.id }},
                name: {{ sat.name | tojson }},
                sat_long: {{ sat.sat_long }},
                sat_lat: {{ sat.sat_lat }},
                altitude: {{ sat.altitude }},
                orbit_type: {{ sat.orbit_type | tojson }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        };
        {% else %}
        const allSatellites = {};
        {% endif %}

        {% if carriers %}
        const allCarriers = {
            {% for car in carriers %}
            {{ car.id }}: {
                id: {{ car.id }},
                name: {{ car.name | tojson }},
                modcod: {{ car.modcod | tojson }},
                modulation: {{ car.modulation | tojson }},
                fec: {{ car.fec | tojson }},
                roll_off: {{ car.roll_off }},
                spectral_efficiency: {{ car.spectral_efficiency }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        };
        {% else %}
        const allCarriers = {};
        {% endif %}

        {% if ground_stations %}
        const allGroundStations = {
            {% for gs in ground_stations %}
            {{ gs.id }}: {
                id: {{ gs.id }},
                name: {{ gs.name | tojson }},
                site_lat: {{ gs.site_lat }},
                site_long: {{ gs.site_long }},
                altitude: {{ gs.altitude }},
                city: {{ gs.city | tojson }},
                country: {{ gs.country | tojson }},
                climate_zone: {{ gs.climate_zone | tojson }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        };
        {% else %}
        const allGroundStations = {};
        {% endif %}

        // Satellite change handler
        document.getElementById('satellite').addEventListener('change', async function() {
            const satId = this.value;
            const transponderSelect = document.getElementById('transponder');

            if (satId) {
                transponderSelect.innerHTML = '<option value="">Loading...</option>';

                try {
                    const response = await fetch(`/api/transponders?satellite_id=${satId}`);
                    const data = await response.json();

                    transponderSelect.innerHTML = '<option value="">Select Transponder</option>';
                    data.forEach(tp => {
                        allTransponders[tp.id] = tp;
                        transponderSelect.innerHTML += `<option value="${tp.id}">${tp.name} (${tp.freq} GHz)</option>`;
                    });

                    selectedComponents.satellite = allSatellites[satId];
                    updateParamDetails();
                } catch (error) {
                    console.error('Error:', error);
                    transponderSelect.innerHTML = '<option value="">Error loading transponders</option>';
                }
            } else {
                transponderSelect.innerHTML = '<option value="">Select Transponder</option>';
                delete selectedComponents.satellite;
                updateParamDetails();
            }
        });

        // Transponder selection
        document.getElementById('transponder').addEventListener('change', function() {
            const tpId = this.value;
            if (tpId && allTransponders[tpId]) {
                selectedComponents.transponder = allTransponders[tpId];
            } else {
                delete selectedComponents.transponder;
            }
            updateParamDetails();
        });

        // Carrier selection
        document.getElementById('carrier').addEventListener('change', function() {
            const carId = this.value;
            if (carId && allCarriers[carId]) {
                selectedComponents.carrier = allCarriers[carId];
            } else {
                delete selectedComponents.carrier;
            }
            updateParamDetails();
        });

        // Ground Station selection
        document.getElementById('ground_station').addEventListener('change', function() {
            const gsId = this.value;
            if (gsId && allGroundStations[gsId]) {
                selectedComponents.ground_station = allGroundStations[gsId];
            } else {
                delete selectedComponents.ground_station;
            }
            updateParamDetails();
        });

        // Reception type change handler
        document.getElementById('reception_type').addEventListener('change', async function() {
            const type = this.value;
            currentReceptionType = type;
            const receptionDiv = document.getElementById('reception_system');

            if (type) {
                receptionDiv.style.display = 'block';
                const receptionSelect = document.getElementById('reception_id');
                receptionSelect.innerHTML = '<option value="">Loading...</option>';

                try {
                    const response = await fetch(`/api/reception_systems?type=${type}`);
                    const data = await response.json();

                    receptionSelect.innerHTML = '<option value="">Select System</option>';
                    data.forEach(rs => {
                        receptionSelect.innerHTML += `<option value="${rs.id}">${rs.name}</option>`;
                    });
                } catch (error) {
                    console.error('Error:', error);
                    receptionSelect.innerHTML = '<option value="">Error loading systems</option>';
                }
            } else {
                receptionDiv.style.display = 'none';
            }
        });

        // Reception system selection
        document.getElementById('reception_id').addEventListener('change', async function() {
            const recId = this.value;
            const type = currentReceptionType;

            if (recId && type) {
                try {
                    const response = await fetch(`/api/reception_systems?type=${type}`);
                    const data = await response.json();
                    const rec = data.find(r => r.id == recId);
                    if (rec) {
                        selectedComponents.reception_system = rec;
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            } else {
                delete selectedComponents.reception_system;
            }
            updateParamDetails();
        });

        // Update parameter details panel
        function updateParamDetails() {
            const detailsDiv = document.getElementById('paramDetails');
            let html = '';

            if (selectedComponents.satellite) {
                const sat = selectedComponents.satellite;
                html += createDetailItem('Satellite', `
                    <table>
                        <tr><td class="label">Name:</td><td>${sat.name}</td></tr>
                        <tr><td class="label">Longitude:</td><td>${sat.sat_long}°</td></tr>
                        <tr><td class="label">Latitude:</td><td>${sat.sat_lat}°</td></tr>
                        <tr><td class="label">Altitude:</td><td>${sat.altitude} km</td></tr>
                        <tr><td class="label">Orbit Type:</td><td>${sat.orbit_type}</td></tr>
                    </table>
                `);
            }

            if (selectedComponents.transponder) {
                const tp = selectedComponents.transponder;
                html += createDetailItem('Transponder', `
                    <table>
                        <tr><td class="label">Name:</td><td>${tp.name}</td></tr>
                        <tr><td class="label">Frequency:</td><td>${tp.freq} GHz</td></tr>
                        <tr><td class="label">Band:</td><td>${tp.freq_band || 'N/A'}</td></tr>
                        <tr><td class="label">EIRP Max:</td><td>${tp.eirp_max} dBW</td></tr>
                        <tr><td class="label">Bandwidth:</td><td>${tp.b_transp} MHz</td></tr>
                        <tr><td class="label">Polarization:</td><td>${tp.polarization || 'N/A'}</td></tr>
                    </table>
                `);
            }

            if (selectedComponents.carrier) {
                const car = selectedComponents.carrier;
                html += createDetailItem('Carrier', `
                    <table>
                        <tr><td class="label">Name:</td><td>${car.name}</td></tr>
                        <tr><td class="label">MODCOD:</td><td>${car.modcod}</td></tr>
                        <tr><td class="label">Modulation:</td><td>${car.modulation || 'N/A'}</td></tr>
                        <tr><td class="label">FEC:</td><td>${car.fec || 'N/A'}</td></tr>
                        <tr><td class="label">Roll-off:</td><td>${car.roll_off}</td></tr>
                        <tr><td class="label">Spectral Efficiency:</td><td>${car.spectral_efficiency} bit/s/Hz</td></tr>
                    </table>
                `);
            }

            if (selectedComponents.ground_station) {
                const gs = selectedComponents.ground_station;
                html += createDetailItem('Ground Station', `
                    <table>
                        <tr><td class="label">Name:</td><td>${gs.name}</td></tr>
                        <tr><td class="label">Location:</td><td>${gs.city}, ${gs.country}</td></tr>
                        <tr><td class="label">Latitude:</td><td>${gs.site_lat}°</td></tr>
                        <tr><td class="label">Longitude:</td><td>${gs.site_long}°</td></tr>
                        <tr><td class="label">Altitude:</td><td>${gs.altitude} m</td></tr>
                        <tr><td class="label">Climate Zone:</td><td>${gs.climate_zone || 'N/A'}</td></tr>
                    </table>
                `);
            }

            if (selectedComponents.reception_system) {
                const rec = selectedComponents.reception_system;
                const recType = rec.ant_size !== undefined ? 'Complex' : 'Simple';
                let recHtml = `
                    <table>
                        <tr><td class="label">Name:</td><td>${rec.name}</td></tr>
                        <tr><td class="label">Type:</td><td>${recType}</td></tr>
                `;

                if (recType === 'Complex') {
                    recHtml += `
                        <tr><td class="label">Antenna Size:</td><td>${rec.ant_size} m</td></tr>
                        <tr><td class="label">Antenna Efficiency:</td><td>${rec.ant_eff}</td></tr>
                        <tr><td class="label">LNB Gain:</td><td>${rec.lnb_gain} dB</td></tr>
                        <tr><td class="label">LNB Noise Temp:</td><td>${rec.lnb_temp} K</td></tr>
                    `;
                } else {
                    recHtml += `
                        <tr><td class="label">G/T Value:</td><td>${rec.gt_value} dB/K</td></tr>
                        <tr><td class="label">Reference Frequency:</td><td>${rec.frequency} GHz</td></tr>
                    `;
                }
                recHtml += '</table>';
                html += createDetailItem('Reception System', recHtml);
            }

            if (html) {
                detailsDiv.innerHTML = html;
            } else {
                detailsDiv.innerHTML = '<div class="empty-state"><p>Select parameters to see details</p></div>';
            }
        }

        function createDetailItem(title, content) {
            return `<div class="param-detail-item"><div class="param-title">${title}</div>${content}</div>`;
        }

        // Handle form submission
        document.getElementById('calculationForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const data = Object.fromEntries(formData);

            fetch('/api/calculate_link', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayResults(data.results, data.calculation_id);
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred during calculation');
            });
        });

        function displayResults(results, calcId) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <table class="table table-striped">
                    <tr><th>Parameter</th><th>Value</th></tr>
                    <tr><td>Elevation Angle</td><td>${results.elevation_angle?.toFixed(2) || 'N/A'}°</td></tr>
                    <tr><td>Azimuth Angle</td><td>${results.azimuth_angle?.toFixed(2) || 'N/A'}°</td></tr>
                    <tr><td>Distance</td><td>${results.distance?.toFixed(0) || 'N/A'} km</td></tr>
                    <tr><td>Free Space Loss</td><td>${results.a_fs?.toFixed(2) || 'N/A'} dB</td></tr>
                    <tr><td>Gas Attenuation</td><td>${results.a_g?.toFixed(2) || 'N/A'} dB</td></tr>
                    <tr><td>Cloud Attenuation</td><td>${results.a_c?.toFixed(2) || 'N/A'} dB</td></tr>
                    <tr><td>Rain Attenuation</td><td>${results.a_r?.toFixed(2) || 'N/A'} dB</td></tr>
                    <tr><td>Scintillation</td><td>${results.a_s?.toFixed(2) || 'N/A'} dB</td></tr>
                    <tr><td>Total Atmospheric Loss</td><td>${results.a_t?.toFixed(2) || 'N/A'} dB</td></tr>
                    <tr><td>Total Loss</td><td>${results.a_tot?.toFixed(2) || 'N/A'} dB</td></tr>
                    <tr><td>C/N0</td><td>${results.cn0?.toFixed(2) || 'N/A'} dB-Hz</td></tr>
                    <tr><td>SNR</td><td>${results.snr?.toFixed(2) || 'N/A'} dB</td></tr>
                    <tr><td>SNR Threshold</td><td>${results.snr_threshold?.toFixed(2) || 'N/A'} dB</td></tr>
                    <tr><td>Link Margin</td><td>${results.link_margin?.toFixed(2) || 'N/A'} dB</td></tr>
                    <tr><td>Availability</td><td>${results.availability?.toFixed(1) || 'N/A'}%</td></tr>
                    <tr><td>G/T</td><td>${results.gt_value?.toFixed(2) || 'N/A'} dB/K</td></tr>
                </table>
                <div class="mt-3">
                    ${calcId ? `<a href="/calculations/${calcId}" class="btn btn-info">View Details</a>` : ''}
                </div>
            `;
        }
    </script>

    <!-- Add Satellite Modal -->
    <div class="modal fade" id="addSatelliteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Add New Satellite</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addSatelliteForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Name *</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Longitude (degrees) *</label>
                            <input type="number" step="0.01" class="form-control" name="sat_long" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Latitude (degrees)</label>
                            <input type="number" step="0.01" class="form-control" name="sat_lat" value="0">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Altitude (km)</label>
                            <input type="number" step="0.1" class="form-control" name="altitude" value="35786">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Orbit Type</label>
                            <select class="form-select" name="orbit_type">
                                <option value="GEO">GEO</option>
                                <option value="MEO">MEO</option>
                                <option value="LEO">LEO</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Satellite</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Transponder Modal -->
    <div class="modal fade" id="addTransponderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Add New Transponder</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addTransponderForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Name *</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Frequency (GHz) *</label>
                            <input type="number" step="0.001" class="form-control" name="freq" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Frequency Band</label>
                            <select class="form-select" name="freq_band">
                                <option value="">Select...</option>
                                <option value="C">C</option>
                                <option value="Ku">Ku</option>
                                <option value="Ka">Ka</option>
                                <option value="X">X</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">EIRP Max (dBW) *</label>
                            <input type="number" step="0.1" class="form-control" name="eirp_max" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Bandwidth (MHz) *</label>
                            <input type="number" step="0.1" class="form-control" name="b_transp" value="36" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Back Off (dB)</label>
                            <input type="number" step="0.1" class="form-control" name="back_off" value="0">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Polarization</label>
                            <select class="form-select" name="polarization">
                                <option value="">Select...</option>
                                <option value="Linear">Linear</option>
                                <option value="Circular">Circular</option>
                                <option value="Horizontal">Horizontal</option>
                                <option value="Vertical">Vertical</option>
                                <option value="RHCP">RHCP</option>
                                <option value="LHCP">LHCP</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Satellite *</label>
                            <select class="form-select" name="satellite_id" id="transponderSatelliteSelect" required>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Add Transponder</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Carrier Modal -->
    <div class="modal fade" id="addCarrierModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">Add New Carrier</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addCarrierForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Name *</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">MODCOD *</label>
                            <input type="text" class="form-control" name="modcod" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Modulation</label>
                            <input type="text" class="form-control" name="modulation">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">FEC</label>
                            <input type="text" class="form-control" name="fec">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Roll-off</label>
                            <input type="number" step="0.01" class="form-control" name="roll_off" value="0">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Spectral Efficiency (bit/s/Hz)</label>
                            <input type="number" step="0.01" class="form-control" name="spectral_efficiency" value="0">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-info">Add Carrier</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Ground Station Modal -->
    <div class="modal fade" id="addGroundStationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">Add New Ground Station</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addGroundStationForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Name *</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Latitude (degrees) *</label>
                            <input type="number" step="0.01" class="form-control" name="site_lat" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Longitude (degrees) *</label>
                            <input type="number" step="0.01" class="form-control" name="site_long" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Altitude (m)</label>
                            <input type="number" step="0.1" class="form-control" name="altitude" value="0">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">City</label>
                            <input type="text" class="form-control" name="city">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Country</label>
                            <input type="text" class="form-control" name="country">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Climate Zone</label>
                            <input type="text" class="form-control" name="climate_zone">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-warning">Add Ground Station</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Reception Complex Modal -->
    <div class="modal fade" id="addReceptionComplexModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Add Complex Reception System</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addReceptionComplexForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Name *</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ground Station *</label>
                            <select class="form-select" name="ground_station_id" id="receptionComplexGroundStation" required>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Antenna Size (m) *</label>
                            <input type="number" step="0.01" class="form-control" name="ant_size" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Antenna Efficiency (0-1) *</label>
                            <input type="number" step="0.01" min="0" max="1" class="form-control" name="ant_eff" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Coupling Loss (dB)</label>
                            <input type="number" step="0.1" class="form-control" name="coupling_loss" value="0">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Polarization Loss (dB)</label>
                            <input type="number" step="0.1" class="form-control" name="polarization_loss" value="0">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">LNB Gain (dB) *</label>
                            <input type="number" step="0.1" class="form-control" name="lnb_gain" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">LNB Noise Temperature (K) *</label>
                            <input type="number" step="1" class="form-control" name="lnb_temp" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Cable Loss (dB)</label>
                            <input type="number" step="0.1" class="form-control" name="cable_loss" value="0">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Add Reception System</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Reception Simple Modal -->
    <div class="modal fade" id="addReceptionSimpleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title">Add Simple Reception System</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addReceptionSimpleForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Name *</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ground Station *</label>
                            <select class="form-select" name="ground_station_id" id="receptionSimpleGroundStation" required>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">G/T Value (dB/K) *</label>
                            <input type="number" step="0.1" class="form-control" name="gt_value" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Reference Frequency (GHz) *</label>
                            <input type="number" step="0.001" class="form-control" name="frequency" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-secondary">Add Reception System</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Ensure currentReceptionType is accessible
        if (typeof currentReceptionType === 'undefined') {
            var currentReceptionType = null;
        }

        // Add New parameter functions - show modals
        function addNewSatellite() {
            const modal = new bootstrap.Modal(document.getElementById('addSatelliteModal'));
            modal.show();
        }

        function addNewTransponder() {
            const modal = new bootstrap.Modal(document.getElementById('addTransponderModal'));
            modal.show();
            // Populate satellite dropdown
            const satSelect = document.getElementById('transponderSatelliteSelect');
            satSelect.innerHTML = '';
            Object.values(allSatellites).forEach(sat => {
                satSelect.innerHTML += `<option value="${sat.id}">${sat.name}</option>`;
            });
        }

        function addNewCarrier() {
            const modal = new bootstrap.Modal(document.getElementById('addCarrierModal'));
            modal.show();
        }

        function addNewGroundStation() {
            const modal = new bootstrap.Modal(document.getElementById('addGroundStationModal'));
            modal.show();
        }

        function addNewReceptionSystem() {
            if (currentReceptionType === 'complex') {
                const modal = new bootstrap.Modal(document.getElementById('addReceptionComplexModal'));
                modal.show();
                // Populate ground station dropdown
                const gsSelect = document.getElementById('receptionComplexGroundStation');
                gsSelect.innerHTML = '';
                Object.values(allGroundStations).forEach(gs => {
                    gsSelect.innerHTML += `<option value="${gs.id}">${gs.name}</option>`;
                });
            } else if (currentReceptionType === 'simple') {
                const modal = new bootstrap.Modal(document.getElementById('addReceptionSimpleModal'));
                modal.show();
                // Populate ground station dropdown
                const gsSelect = document.getElementById('receptionSimpleGroundStation');
                gsSelect.innerHTML = '';
                Object.values(allGroundStations).forEach(gs => {
                    gsSelect.innerHTML += `<option value="${gs.id}">${gs.name}</option>`;
                });
            } else {
                alert('Please select a reception system type first');
            }
        }

        // Handle form submissions for adding new components
        function setupAddForm(formId, apiUrl, successCallback) {
            const form = document.getElementById(formId);
            if (!form) return;

            form.addEventListener('submit', async function(e) {
                e.preventDefault();

                const formData = new FormData(this);
                const data = Object.fromEntries(formData);

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (result.success) {
                        const modalEl = this.closest('.modal');
                        const modal = bootstrap.Modal.getInstance(modalEl);
                        modal.hide();
                        form.reset();
                        alert('Added successfully!');
                        if (successCallback) successCallback(result);
                    } else {
                        alert('Error: ' + (result.error || 'Failed to add'));
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Network error: ' + error.message);
                }
            });
        }

        // Setup all add forms
        document.addEventListener('DOMContentLoaded', function() {
            setupAddForm('addSatelliteForm', '/api/satellites/add', function(result) {
                const satSelect = document.getElementById('satellite');
                const formName = document.getElementById('addSatelliteForm').querySelector('[name="name"]').value;
                const newOption = document.createElement('option');
                newOption.value = result.satellite_id;
                newOption.textContent = formName;
                satSelect.appendChild(newOption);
                satSelect.value = result.satellite_id;
                satSelect.dispatchEvent(new Event('change'));
            });

            setupAddForm('addTransponderForm', '/api/transponders/add', function(result) {
                const satId = document.getElementById('satellite').value;
                if (satId) {
                    const tpSelect = document.getElementById('transponder');
                    tpSelect.innerHTML = '<option value="">Select Transponder</option>';
                    fetch(`/api/transponders?satellite_id=${satId}`)
                        .then(response => response.json())
                        .then(data => {
                            data.forEach(tp => {
                                allTransponders[tp.id] = tp;
                                const option = document.createElement('option');
                                option.value = tp.id;
                                option.textContent = `${tp.name} (${tp.freq} GHz)`;
                                if (tp.id === result.transponder_id) option.selected = true;
                                tpSelect.appendChild(option);
                            });
                            tpSelect.dispatchEvent(new Event('change'));
                        });
                }
            });

            setupAddForm('addCarrierForm', '/api/carriers/add', function(result) {
                const carSelect = document.getElementById('carrier');
                const formName = document.getElementById('addCarrierForm').querySelector('[name="name"]').value;
                const formModcod = document.getElementById('addCarrierForm').querySelector('[name="modcod"]').value;
                const newOption = document.createElement('option');
                newOption.value = result.carrier_id;
                newOption.textContent = `${formName} (${formModcod})`;
                carSelect.appendChild(newOption);
                carSelect.value = result.carrier_id;
                carSelect.dispatchEvent(new Event('change'));
            });

            setupAddForm('addGroundStationForm', '/api/ground_stations/add', function(result) {
                const gsSelect = document.getElementById('ground_station');
                const formName = document.getElementById('addGroundStationForm').querySelector('[name="name"]').value;
                const newOption = document.createElement('option');
                newOption.value = result.ground_station_id;
                newOption.textContent = formName;
                gsSelect.appendChild(newOption);
                gsSelect.value = result.ground_station_id;
                gsSelect.dispatchEvent(new Event('change'));
            });

            setupAddForm('addReceptionComplexForm', '/api/reception_complex/add', function(result) {
                const recSelect = document.getElementById('reception_id');
                const formName = document.getElementById('addReceptionComplexForm').querySelector('[name="name"]').value;
                const newOption = document.createElement('option');
                newOption.value = result.reception_id;
                newOption.textContent = formName;
                recSelect.appendChild(newOption);
                recSelect.value = result.reception_id;
                recSelect.dispatchEvent(new Event('change'));
            });

            setupAddForm('addReceptionSimpleForm', '/api/reception_simple/add', function(result) {
                const recSelect = document.getElementById('reception_id');
                const formName = document.getElementById('addReceptionSimpleForm').querySelector('[name="name"]').value;
                const newOption = document.createElement('option');
                newOption.value = result.reception_id;
                newOption.textContent = formName;
                recSelect.appendChild(newOption);
                recSelect.value = result.reception_id;
                recSelect.dispatchEvent(new Event('change'));
            });
        });
    </script>
</body>
</html>
