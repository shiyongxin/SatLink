<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Calculation - SatLink</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">SatLink</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/dashboard">Dashboard</a>
                <a class="nav-link" href="/calculate">Calculate</a>
                <a class="nav-link" href="/calculations">Calculations</a>
                <a class="nav-link" href="/manage">Manage</a>
                <a class="nav-link" href="/public">Public</a>
                <a class="nav-link" href="/profile">Profile</a>
                <a class="nav-link" href="/logout">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <h1>Link Calculation</h1>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Input Parameters</h5>
                    </div>
                    <div class="card-body">
                        <form id="calculationForm">
                            <div class="mb-3">
                                <label for="satellite" class="form-label">Satellite</label>
                                <select class="form-select" id="satellite" name="satellite_id" required>
                                    <option value="">Select Satellite</option>
                                    {% for sat in satellites %}
                                        <option value="{{ sat.id }}">{{ sat.name }} ({{ sat.sat_long }}°)</option>
                                    {% endfor %}
                                </select>
                                {% if not satellites %}
                                    <div class="alert alert-info mt-2" role="alert">
                                        <i class="fas fa-info-circle"></i> No satellites found.
                                        <a href="/manage#add-satellite" class="alert-link">Add a new satellite</a>.
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label for="transponder" class="form-label">Transponder</label>
                                <select class="form-select" id="transponder" name="transponder_id" required>
                                    <option value="">Select Transponder</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="carrier" class="form-label">Carrier</label>
                                <select class="form-select" id="carrier" name="carrier_id" required>
                                    <option value="">Select Carrier</option>
                                    {% for car in carriers %}
                                        <option value="{{ car.id }}">{{ car.name }} ({{ car.modcod }})</option>
                                    {% endfor %}
                                </select>
                                {% if not carriers %}
                                    <div class="alert alert-info mt-2" role="alert">
                                        <i class="fas fa-info-circle"></i> No carriers found.
                                        <a href="/manage#add-carrier" class="alert-link">Add a new carrier</a>.
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label for="ground_station" class="form-label">Ground Station</label>
                                <select class="form-select" id="ground_station" name="ground_station_id" required>
                                    <option value="">Select Ground Station</option>
                                    {% for gs in ground_stations %}
                                        <option value="{{ gs.id }}">{{ gs.name }} ({{ gs.city }}, {{ gs.country }})</option>
                                    {% endfor %}
                                </select>
                                {% if not ground_stations %}
                                    <div class="alert alert-info mt-2" role="alert">
                                        <i class="fas fa-info-circle"></i> No ground stations found.
                                        <a href="/manage#add-ground-station" class="alert-link">Add a new ground station</a>.
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label for="reception_type" class="form-label">Reception System Type</label>
                                <select class="form-select" id="reception_type" name="reception_type" required>
                                    <option value="">Select Type</option>
                                    <option value="complex">Complex (Detailed Hardware)</option>
                                    <option value="simple">Simple (G/T Value)</option>
                                </select>
                            </div>

                            <div class="mb-3" id="reception_system" style="display: none;">
                                <label for="reception_id" class="form-label">Reception System</label>
                                <select class="form-select" id="reception_id" name="reception_id" required>
                                    <option value="">Select System</option>
                                </select>
                            </div>

                            <button type="submit" class="btn btn-primary">Calculate</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Selected Parameters</h5>
                    </div>
                    <div class="card-body">
                        <div id="selected-params" class="mb-3">
                            <p class="text-muted">No parameters selected yet</p>
                        </div>

                        <hr>

                        <h5>Parameter Details</h5>
                        <div id="parameter-details" class="mb-3">
                            <p class="text-muted">Select parameters to view details</p>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        <h5>Calculation Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="results" class="text-center">
                            <p class="text-muted">Complete the form to see results</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Store selected parameters
        let selectedParams = {
            satellite: null,
            transponder: null,
            carrier: null,
            ground_station: null,
            reception_type: null,
            reception_system: null
        };

        // Load transponders based on satellite selection
        document.getElementById('satellite').addEventListener('change', function() {
            const satId = this.value;
            const satName = this.options[this.selectedIndex].text;
            const transponderSelect = document.getElementById('transponder');

            selectedParams.satellite = satId ? {id: satId, name: satName} : null;
            updateParameterDisplay();

            if (satId) {
                transponderSelect.innerHTML = '<option value="">Loading...</option>';

                fetch(`/api/transponders?satellite_id=${satId}`)
                    .then(response => response.json())
                    .then(data => {
                        transponderSelect.innerHTML = '<option value="">Select Transponder</option>';
                        data.forEach(tp => {
                            transponderSelect.innerHTML += `<option value="${tp.id}">${tp.name} (${tp.freq} GHz)</option>`;
                        });
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        transponderSelect.innerHTML = '<option value="">Error loading transponders</option>';
                    });
            } else {
                transponderSelect.innerHTML = '<option value="">Select Transponder</option>';
                selectedParams.transponder = null;
                updateParameterDisplay();
            }
        });

        document.getElementById('transponder').addEventListener('change', function() {
            const tpId = this.value;
            const tpName = this.options[this.selectedIndex].text;
            selectedParams.transponder = tpId ? {id: tpId, name: tpName} : null;
            updateParameterDisplay();
        });

        document.getElementById('carrier').addEventListener('change', function() {
            const carId = this.value;
            const carName = this.options[this.selectedIndex].text;
            selectedParams.carrier = carId ? {id: carId, name: carName} : null;
            updateParameterDisplay();
        });

        document.getElementById('ground_station').addEventListener('change', function() {
            const gsId = this.value;
            const gsName = this.options[this.selectedIndex].text;
            selectedParams.ground_station = gsId ? {id: gsId, name: gsName} : null;
            updateParameterDisplay();
        });

        // Load reception systems based on type
        document.getElementById('reception_type').addEventListener('change', function() {
            const type = this.value;
            const typeText = this.options[this.selectedIndex].text;
            const receptionDiv = document.getElementById('reception_system');
            const receptionSelect = document.getElementById('reception_id');

            selectedParams.reception_type = type ? {id: type, name: typeText} : null;
            updateParameterDisplay();

            if (type) {
                receptionDiv.style.display = 'block';
                receptionSelect.innerHTML = '<option value="">Loading...</option>';

                fetch(`/api/reception_systems?type=${type}`)
                    .then(response => response.json())
                    .then(data => {
                        receptionSelect.innerHTML = '<option value="">Select System</option>';
                        data.forEach(rs => {
                            receptionSelect.innerHTML += `<option value="${rs.id}">${rs.name}</option>`;
                        });
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        receptionSelect.innerHTML = '<option value="">Error loading systems</option>';
                    });
            } else {
                receptionDiv.style.display = 'none';
                selectedParams.reception_system = null;
                updateParameterDisplay();
            }
        });

        document.getElementById('reception_id').addEventListener('change', function() {
            const rsId = this.value;
            const rsName = this.options[this.selectedIndex].text;
            selectedParams.reception_system = rsId ? {id: rsId, name: rsName} : null;
            updateParameterDisplay();
        });

        function updateParameterDisplay() {
            const paramsDiv = document.getElementById('selected-params');
            const detailsDiv = document.getElementById('parameter-details');

            // Update selected parameters
            const paramNames = {
                satellite: 'Satellite',
                transponder: 'Transponder',
                carrier: 'Carrier',
                ground_station: 'Ground Station',
                reception_type: 'Reception Type',
                reception_system: 'Reception System'
            };

            let hasParams = false;
            let paramsHtml = '<div class="row"><div class="col-md-6">';

            for (const [key, value] of Object.entries(selectedParams)) {
                if (value) {
                    hasParams = true;
                    paramsHtml += `
                        <div class="mb-2">
                            <strong>${paramNames[key]}:</strong> ${value.name}
                            <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="clearParameter('${key}')">Clear</button>
                        </div>
                    `;
                }
            }

            paramsHtml += '</div></div>';

            if (hasParams) {
                paramsDiv.innerHTML = paramsHtml;

                // Show parameter details if all params selected
                if (selectedParams.satellite && selectedParams.transponder &&
                    selectedParams.carrier && selectedParams.ground_station &&
                    selectedParams.reception_type) {

                    // Get detailed information
                    getParameterDetails();
                } else {
                    detailsDiv.innerHTML = '<p class="text-muted">Select all parameters to view details</p>';
                }
            } else {
                paramsDiv.innerHTML = '<p class="text-muted">No parameters selected yet</p>';
                detailsDiv.innerHTML = '<p class="text-muted">Select parameters to view details</p>';
            }
        }

        function clearParameter(param) {
            selectedParams[param] = null;

            // Clear the corresponding select element
            const selectElement = document.getElementById(param);
            if (selectElement) {
                selectElement.value = '';

                // Trigger change event if needed
                if (param === 'satellite') {
                    selectedParams.transponder = null;
                    document.getElementById('transponder').value = '';
                } else if (param === 'reception_type') {
                    selectedParams.reception_system = null;
                    document.getElementById('reception_system').style.display = 'none';
                    document.getElementById('reception_id').value = '';
                }
            }

            updateParameterDisplay();
        }

        function getParameterDetails() {
            const detailsDiv = document.getElementById('parameter-details');

            // This is a simplified version - in a real app, you'd fetch detailed data
            detailsDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Selected Parameters:</h6>
                        <ul class="list-unstyled">
                            <li><strong>Satellite:</strong> ${selectedParams.satellite.name}</li>
                            <li><strong>Transponder:</strong> ${selectedParams.transponder.name}</li>
                            <li><strong>Carrier:</strong> ${selectedParams.carrier.name}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Additional Details:</h6>
                        <ul class="list-unstyled">
                            <li><strong>Ground Station:</strong> ${selectedParams.ground_station.name}</li>
                            <li><strong>Reception Type:</strong> ${selectedParams.reception_type.name}</li>
                            ${selectedParams.reception_system ? `<li><strong>Reception System:</strong> ${selectedParams.reception_system.name}</li>` : ''}
                        </ul>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        Click "Calculate" to perform the link budget calculation with these parameters.
                    </small>
                </div>
            `;
        }

        // Handle form submission
        document.getElementById('calculationForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const data = Object.fromEntries(formData);

            fetch('/api/calculate_link', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayResults(data.results);
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred during calculation');
            });
        });

        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <table class="table table-striped">
                    <tr><th>Parameter</th><th>Value</th></tr>
                    <tr><td>Elevation Angle</td><td>${results.elevation_angle?.toFixed(2) || 'N/A'}°</td></tr>
                    <tr><td>Azimuth Angle</td><td>${results.azimuth_angle?.toFixed(2) || 'N/A'}°</td></tr>
                    <tr><td>Distance</td><td>${results.distance?.toFixed(0) || 'N/A'} km</td></tr>
                    <tr><td>Free Space Loss</td><td>${results.a_fs?.toFixed(2) || 'N/A'} dB</td></tr>
                    <tr><td>Gas Attenuation</td><td>${results.a_g?.toFixed(2) || 'N/A'} dB</td></tr>
                    <tr><td>Cloud Attenuation</td><td>${results.a_c?.toFixed(2) || 'N/A'} dB</td></tr>
                    <tr><td>Rain Attenuation</td><td>${results.a_r?.toFixed(2) || 'N/A'} dB</td></tr>
                    <tr><td>Scintillation</td><td>${results.a_s?.toFixed(2) || 'N/A'} dB</td></tr>
                    <tr><td>Total Atmospheric Loss</td><td>${results.a_t?.toFixed(2) || 'N/A'} dB</td></tr>
                    <tr><td>Total Loss</td><td>${results.a_tot?.toFixed(2) || 'N/A'} dB</td></tr>
                    <tr><td>C/N0</td><td>${results.cn0?.toFixed(2) || 'N/A'} dB-Hz</td></tr>
                    <tr><td>SNR</td><td>${results.snr?.toFixed(2) || 'N/A'} dB</td></tr>
                    <tr><td>SNR Threshold</td><td>${results.snr_threshold?.toFixed(2) || 'N/A'} dB</td></tr>
                    <tr><td>Link Margin</td><td>${results.link_margin?.toFixed(2) || 'N/A'} dB</td></tr>
                    <tr><td>Availability</td><td>${results.availability?.toFixed(1) || 'N/A'}%</td></tr>
                    <tr><td>G/T</td><td>${results.gt_value?.toFixed(2) || 'N/A'} dB/K</td></tr>
                </table>
                <div class="mt-3">
                    <a href="/calculations/${data.calculation_id}" class="btn btn-info">View Details</a>
                </div>
            `;
        }
    </script>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</body>
</html>